<!doctype html>
<meta charset="utf-8">
<title>Treasure hunter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<style> * {margin: 0; padding: 0;} </style>
<body>
<script src="libs/ga.js"></script>
<script src="libs/plugins.js"></script>
<script src="libs/phaser.min.js"></script>
<script src="src/houseBuilder.js"></script>
<script src="src/scoreCounter.js"></script>
<script>
var shootTime = 0;
var bg, gifts, controls, sleighHalfWidth, sleighHalfHeight, bgV, hb, gap, isFirstGap;
var mainState = {
    preload: function() {
        this.load.image('treasure', 'assets/images/SantaGame.png');
        this.load.image('sleigh', 'assets/images/santa_sleigh2.png');
        this.load.image('bg', 'assets/images/rsz_landscape2.png');

        this.load.image('houseDarkBottomLeft', 'assets/images/tiles/houseDarkBottomLeft.png');
        this.load.image('houseDarkBottomMid', 'assets/images/tiles/houseDarkBottomMid.png');
        this.load.image('houseDarkBottomRight', 'assets/images/tiles/houseDarkBottomRight.png');
        this.load.image('houseDarkMidLeft', 'assets/images/tiles/houseDarkMidLeft.png');
        this.load.image('houseDark', 'assets/images/tiles/houseDark.png');
        this.load.image('houseDarkMidRight', 'assets/images/tiles/houseDarkMidRight.png');
        this.load.image('windowCheckered', 'assets/images/tiles/windowCheckered.png');
        this.load.image('doorTop', 'assets/images/tiles/doorTop.png');
        this.load.image('doorKnobAlt', 'assets/images/tiles/doorKnobAlt.png');
        this.load.image('roofRedRight', 'assets/images/tiles/roofRedRight.png');
        this.load.image('roofRedTopMid', 'assets/images/tiles/roofRedTopMid.png');
        this.load.image('roofRedTopLeft', 'assets/images/tiles/roofRedTopLeft.png');
        this.load.image('chimneyThin', 'assets/images/tiles/chimneyThin.png');
        this.load.image('chimneyLow', 'assets/images/tiles/chimneyLow.png');

        this.load.image('houseBeigeBottomLeft', 'assets/images/tiles/houseBeigeBottomLeft.png');
        this.load.image('houseBeigeBottomMid', 'assets/images/tiles/houseBeigeBottomMid.png');
        this.load.image('houseBeigeBottomRight', 'assets/images/tiles/houseBeigeBottomRight.png');
        this.load.image('houseBeigeMidLeft', 'assets/images/tiles/houseBeigeMidLeft.png');
        this.load.image('houseBeige', 'assets/images/tiles/houseBeige.png');
        this.load.image('houseBeigeMidRight', 'assets/images/tiles/houseBeigeMidRight.png');

        this.load.spritesheet('babka', 'assets/images/babka.png', 72, 58, 10);

        game.onCollideSignal = new Phaser.Signal();
        game.onAfterCollideSignal = new Phaser.Signal();
        hb = new HouseBuilder(game);
        sc = new ScoreCounter(game);
        game.onCollideSignal.add(sc.onCollide, sc);
        game.onAfterCollideSignal.add(hb.onAfterCollide, hb);
    },

    create: function() {
        bgV = 2;
        bg = game.add.tileSprite(0, 0, 400, 490, 'bg');

        sleighHalfWidth = this.game.cache.getImage('sleigh').width/2;
        sleighHalfHeight = this.game.cache.getImage('sleigh').height/2;

        this.player = this.game.add.sprite(this.game.width/2 - sleighHalfWidth, 45, 'sleigh');
        gifts = this.game.add.group();
        gifts.enableBody = true;
        gifts.physicsBodyType = Phaser.Physics.ARCADE;
        gifts.createMultiple(10, 'treasure');

        gifts.setAll('anchor.x', 0.5);
        gifts.setAll('anchor.y', 0.5);

/*        gifts.setAll('scale.x', 0.5);
        gifts.setAll('scale.y', 0.5);*/

        gifts.setAll('outOfBoundsKill', true);
        gifts.setAll('checkWorldBounds', true);

        game.world.bringToTop(this.player);

        controls = {
            shoot: this.input.keyboard.addKey(Phaser.Keyboard.DOWN)
        };

        this.timer = game.time.events.loop(3000, function(){
            var gap = this.game.rnd.realInRange(100, 350)
            var xStart = Math.max(401, hb.getMaxPosX()) + gap;
            hb.addHouse(xStart, 490 - 70);
        }, this);

        this.labelScore = game.add.text(20, 20, "0",
            { font: "30px Arial", fill: "#ff0000" });
    },

    update: function() {
        bg.tilePosition.x -= bgV;

        if (controls.shoot.isDown) {
            this.shootGift();
        }

        hb.checkCollision(gifts);

        this.labelScore.text = sc.getScore();
    },

    shootGift: function() {
        if (this.time.now > shootTime) {
            gift = gifts.getFirstExists(false);
            if (gift) {
                gift.reset(this.player.x + 40, this.player.y + sleighHalfHeight);
                gift.body.velocity.y = +600;
                shootTime = this.time.now + 200;
            }
        }
    }
};

var game = new Phaser.Game(400, 490);
game.state.add('main', mainState);
game.state.start('main');

// var windowHalfWidth = 512;
// var g = ga(
//   windowHalfWidth*2, 512, splash,
//   [
//     "assets/images/SantaGame.json",
//     "assets/images/landscape.json",
//     "assets/images/houses.json",
//     "assets/images/finish.json",
//     "assets/images/babka.json",
//     "assets/images/happyboy.json",
//     "assets/images/happyevil.json",
//     "assets/images/splash.json",
//     "assets/images/snowy_background.json",
//     "assets/images/howto.json",
//     "assets/images/howtobtn2.png"
//   ],
//   load
// );

// var player, hb, sc, traject, bullets, landscape, numberOfHouses, finish, scoreDisplay, score,
// splash, sign, gname, creatorText, playBtn, howtoBtn, shareBtn, bg, howto, instructions, lights, lightsBt, howtoBg, howtoDisplay;

// function splash() {
//     g.progressBar.remove();

//     splash = g.group();

//     bg = g.sprite("background.jpg");
//     bg.x = 0;
//     bg.y = 0;
//     splash.addChild(bg);

//     //for debug
//     // for (var j = 0; j < 512; j += 50) {
//     //     var l = g.rectangle(1024, 1, "blue");
//     //     l.x = 0;
//     //     l.y = j;
//     //     splash.addChild(l);
//     // }

//     sign = g.sprite("sign2.png");
//     sign.x = 40;
//     sign.y = 512 - sign.halfHeight*2;
//     splash.addChild(sign);

//     gname = g.sprite("name.png");
//     gname.x = 512 - gname.halfWidth;
//     gname.y = 256 - gname.halfHeight*2;
//     splash.addChild(gname);

//     creatorText = g.text("0", "20px tahoma", "#00284d", 1000, 10);
//     creatorText.content = "created by";
//     creatorText.x = 380;
//     creatorText.y = 70;
//     splash.addChild(creatorText);

//     divanlogo = g.sprite("divan_logo.png");
//     divanlogo.x = 512 - divanlogo.halfWidth + 30;
//     divanlogo.y = 30;
//     splash.addChild(divanlogo);

//     sleigh = g.sprite("santa_sleigh2.png");
//     sleigh.x = gname.x + gname.halfWidth*2;
//     sleigh.y = gname.y - 20;
//     splash.addChild(sleigh);

//     playBtn = g.button([
//       "playbtn2.png",
//       "playbtn2.png",
//       "playbtn2.png"
//     ]);
//     playBtn.x = sign.x + 60;
//     playBtn.y = sign.y + 185;

//     playBtn.release = function(){
//       alert("play!");
//     };

//     shareBtn = g.button([
//       "sharebtn2.png",
//       "sharebtn2.png",
//       "sharebtn2.png"
//     ]);
//     shareBtn.x = sign.x + 60;
//     shareBtn.y = sign.y + 250;

//     shareBtn.release = function(){
//       alert("share!");
//     };
//     var buttonFrames = g.frames(
//         "assets/images/howtobtn2.png",
//         [[0,0],[0,25],[0,50]],
//         105,25
//       );

//     howtoBtn = g.button(buttonFrames);

//     howtoBtn.x = sign.gx + 60;
//     howtoBtn.y = sign.gy + 95;
//     splash.addChild(howtoBtn);

//     howtoBtn.release = function(){
//       g.state = howto;
//     };
// }

// function howto() {
//     sign.visible = false;
//     gname.visible = false;
//     creatorText.visible = false;
//     divanlogo.visible = false;
//     sleigh.visible = false;
//     playBtn.visible = false;
//     shareBtn.visible = false;
//     howtoBtn.visible = false;

//     instructions = g.sprite("instructions.png");
//     instructions.x = 512 - instructions.halfWidth;
//     instructions.y = 50;
//     splash.addChild(instructions);

//     howtoBg = g.rectangle(480, 300, "white");
//     howtoBg.x = 512 - howtoBg.halfWidth;
//     howtoBg.y = 130;
//     splash.addChild(howtoBg);

//     lights = g.sprite("lights2.png");
//     lights.x = 512 - lights.halfWidth;
//     lights.y = 100;
//     splash.addChild(lights);

//     lightsBt = g.sprite("lights_bottom.png");
//     lightsBt.x = 512 - lightsBt.halfWidth;
//     lightsBt.y = g.canvas.height - 50 - lightsBt.halfHeight*2;
//     splash.addChild(lightsBt);

//     howtoDisplay = g.text("0", "20px tahoma", "#000000", 1000, 10);
//     howtoDisplay.content = "Dear Santa, you have a limited number of gifts so give them out wisely. If you give a gift to a bad boy you won't receive points for that. If a bad boy lives on the last floor he'll receive all the gifts that you'll drop. Use down arrow to drop gifts.";

//    howtoDisplay.x = lights.x + 30;
//    howtoDisplay.y = lights.y + 80;
//    splash.addChild(howtoDisplay);
// }
</script>
</body>
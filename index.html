<!doctype html>
<meta charset="utf-8">
<title>Treasure hunter</title>
<style> * {margin: 0; padding: 0;} </style>
<body>
<script src="libs/ga.js"></script>
<script src="libs/plugins.js"></script>
<script>
var windowHalfWidth = 512;
var g = ga(
  windowHalfWidth*2, 512, setup,
  [
    "assets/images/SantaGame.json",
    "assets/images/landscape.json",
    "assets/images/houses.json",
    "assets/images/finish.json",
  ],
  load
);

var player, traject, bullets, hitChimneys, landscape, housesSprites, numberOfHouses, finish, chimneys, scoreDisplay, score;

g.start();
g.scaleToWindow();

window.addEventListener("resize", function(event){
  g.scaleToWindow();
});

function setup() {
    g.progressBar.remove();

    g.canvas.style.border = "1px black dashed";
    g.backgroundColor = "white";
    g.state = play;

    landscape = g.tilingSprite(
      g.canvas.width,        //The width
      g.canvas.height,       //The height
      "landscape.png"        //The image to use
    );

    scoreDisplay = g.text("0", "20px tahoma", "#00FF00", 1000, 10);

    bullets = [];
    chimneys = g.group();
    score = 0;

    gameScene = g.group();

    //for debug
    for (var j = 35; j < 1024; j += 35) {
        var l = g.rectangle(1, 512, "blue");
        l.x = j;
        l.y = 0;
        gameScene.addChild(l);

        var lineDisplay = g.text(j, "10px tahoma", "#00FF00", j, 5);
        gameScene.addChild(lineDisplay);
    }

    player = g.rectangle(144, 48, "blue");
    player.x = windowHalfWidth - player.halfWidth;
    //player.y = 8;
    player.y = 18;
    gameScene.addChild(player);

    traject = g.rectangle(5, 100, "red");
    traject.visible = false;
    gameScene.addChild(traject);

    housesSprites = g.group();

    var minGapSize = 70;
    var maxGapSize = 100;
    //numberOfHouses = 6;
    numberOfHouses = 100;
    var currX = 70;

    for (var i = 0; i < numberOfHouses; i++) {
        if (i % 2 == 0) {
            buildFirstHouse(currX, g.canvas.height - 70);
        } else {
            buildSecondHouse(currX, g.canvas.height - 70);
        }
        currX += 350;

        if (i === numberOfHouses - 1) {
            finish = g.sprite("finish.png");
            housesSprites.addChild(finish);
            finish.x = currX + 350;
            finish.y = g.canvas.height/2 - finish.halfHeight;
        }
    }

    g.pointer.press = function() {
        traject.x = player.x + player.halfWidth;
        traject.y = player.y + 2*player.halfHeight;
        traject.visible = true;
    }

    g.pointer.release = function() {
        traject.visible = false;
        g.shoot(
            player,      //The shooting sprite
            1.57,        //The angle, in radians, at which to shoot (4.71 is up)
            16,          //The bullet's offset from the center of the sprite
            7,           //The bullet's speed (pixels per frame)
            bullets,
            function() {
                return g.sprite("treasure.png");
            }
        );
    }
}

function buildFirstHouse(x, y) {
    addHousePart("houseBeigeBottomLeft.png", x, y);
    addHousePart("houseBeigeBottomMid.png", x + 70, y);
    addHousePart("houseBeigeBottomRight.png", x + 140, y);
    addHousePart("houseBeigeMidLeft.png", x, y - 70);
    addHousePart("houseBeige.png", x + 70, y - 70);
    addHousePart("houseBeigeMidRight.png", x + 140, y - 70);

    addHousePart("windowCheckered.png", x + 25, y - 40);
    addHousePart("doorTop.png", x + 110, y - 70);
    addHousePart("doorKnobAlt.png", x + 110, y);

    addHousePart("houseBeigeMidLeft.png", x, y - 140);
    addHousePart("houseBeige.png", x + 70, y - 140);
    addHousePart("houseBeigeMidRight.png", x + 140, y - 140);

    addHousePart("windowCheckered.png", x + 25, y - 130);
    addHousePart("windowCheckered.png", x + 110, y - 130);

    addHousePart("roofRedRight.png", x - 70, y - 210);
    addHousePart("roofRedTopMid.png", x, y - 210);
    addHousePart("roofRedTopMid.png", x + 70, y - 210);
    addHousePart("roofRedTopMid.png", x + 140, y - 210);
    addHousePart("roofRedTopLeft.png", x + 210, y - 210);

    addHousePart("chimneyThin.png", x + 120, y - 280);
}

function buildSecondHouse(x, y) {
    addHousePart("houseBeigeBottomLeft.png", x, y);
    addHousePart("houseBeigeBottomMid.png", x + 70, y);
    addHousePart("houseBeigeBottomRight.png", x + 140, y);
    addHousePart("houseBeigeMidLeft.png", x, y - 70);
    addHousePart("houseBeige.png", x + 70, y - 70);
    addHousePart("houseBeigeMidRight.png", x + 140, y - 70);

    addHousePart("windowCheckered.png", x + 25, y - 40);
    addHousePart("doorTop.png", x + 110, y - 70);
    addHousePart("doorKnobAlt.png", x + 110, y);

    addHousePart("houseBeigeMidLeft.png", x, y - 140);
    addHousePart("houseBeige.png", x + 70, y - 140);
    addHousePart("houseBeigeMidRight.png", x + 140, y - 140);

    addHousePart("windowCheckered.png", x + 25, y - 130);
    addHousePart("windowCheckered.png", x + 110, y - 130);

    addHousePart("roofRedRight.png", x - 70, y - 210);
    addHousePart("roofRedTopMid.png", x, y - 210);
    addHousePart("roofRedTopMid.png", x + 70, y - 210);
    addHousePart("roofRedTopMid.png", x + 140, y - 210);
    addHousePart("roofRedTopLeft.png", x + 210, y - 210);

    addHousePart("chimneyLow.png", x + 120, y - 280);
}

function addHousePart(name, x, y) {
    var houseSprite = g.sprite(name);

    houseSprite.x = x;
    houseSprite.y = y;

    if (name == "chimneyLow.png" || name == "chimneyThin.png") {
        houseSprite.hit = false;
        chimneys.addChild(houseSprite);
    } else {
        housesSprites.addChild(houseSprite);
    }
}

function play() {
    landscape.tileX -= 1;

    g.move(bullets);

    if (finish.gx > g.canvas.width) {
        housesSprites.x -= 2;
        chimneys.x -= 2;
    }

    bullets.forEach(function(bullet) {
        if (bullet.y >= 162 && bullet.y < 512) {
            var bulletVsBlock = chimneys.children.some(function(chimney){
                if (!chimney.hit) {
                    var hit = g.hitTestRectangle(bullet, chimney, true);
                    if (hit) {
                        chimney.hit = true;
                    }
                    return hit;
                }
            });
            if (bulletVsBlock) {
                score += 1;
            }
        }
    });

    scoreDisplay.content = score;
}

function end() {
}

function load(){
    g.progressBar.create(g.canvas, g.assets);
    g.progressBar.update();
}
</script>
</body>
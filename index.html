<!doctype html>
<meta charset="utf-8">
<title>Treasure hunter</title>
<body>
<script src="libs/ga.js"></script>
<script src="libs/plugins.js"></script>
<script>
var g = ga(
  512, 512, setup,
  [
    "assets/sounds/battleThemeA.mp3"
  ]
);
var dungeon, player, treasure, enemies, chimes, exit,
    healthBar, message, gameScene, gameOverScene;

g.start();

function setup() {
    g.canvas.style.border = "1px black dashed";
    g.backgroundColor = "white";
    g.state = play;

    gameScene = g.group();

    exit = g.rectangle(48, 48, "green");
    exit.x = 8;
    exit.y = 8;
    gameScene.addChild(exit);

    player = g.rectangle(32, 32, "blue");
    player.x = 68;
    player.y = g.canvas.height / 2 - player.halfHeight;
    gameScene.addChild(player);

    treasure = g.rectangle(16, 16, "gold");

    treasure.x = g.canvas.width - treasure.width - 32;
    treasure.y = g.canvas.height / 2 - treasure.halfHeight;

    treasure.pickedUp = false;

    gameScene.addChild(treasure);

    var numberOfEnemies = 6,
    spacing = 48,
    xOffset = 150,
    speed = 2,
    direction = 1;

    enemies = [];

    for (var i = 0; i < numberOfEnemies; i++) {
        var enemy = g.rectangle(32, 32, "red");
        var x = spacing * i + xOffset;
        var y = g.randomInt(0, g.canvas.height - enemy.height);

        enemy.x = x;
        enemy.y = y;

        //Set the enemy's vertical velocity. `direction` will be either `1` or
        //`-1`. `1` means the enemy will move down and `-1` means the enemy will
        //move up. Multiplying `direction` by `speed` determines the enemy's
        //vertical direction
        enemy.vy = speed * direction;

        //Reverse the direction for the next enemy
        direction *= -1;

        enemies.push(enemy);
        gameScene.addChild(enemy);

        var outerBar = g.rectangle(128, 16, "black"),
            innerBar = g.rectangle(128, 16, "yellowGreen");
        healthBar = g.group(outerBar, innerBar);
        healthBar.inner = innerBar;
        healthBar.x = g.canvas.width - 148;
        healthBar.y = 16;
        gameScene.addChild(healthBar);
        healthBar.inner.width = 30;

        message = g.text("Game Over!", "64px Futura", "black", 20, 20);
        message.x = 120;
        message.y = g.canvas.height / 2 - 64;

        gameOverScene = g.group(message);
        gameOverScene.visible = false;

        g.fourKeyController(player, 5, 38, 39, 40, 37);
    }
}

function play() {
    var playerHitsEdges = g.contain(player, g.stage.localBounds);
    if (playerHitsEdges) {
        message.content
        = "The player hit the " + playerHitsEdges + " of the canvas";
    }
    g.move(player);

    var playerHit = false;

    enemies.forEach(function(enemy) {
        g.move(enemy);

        var enemyHitsEdges = g.contain(enemy, g.stage.localBounds);
        if (enemyHitsEdges === "top" || enemyHitsEdges === "bottom") {
            enemy.vy *= -1;
        }
        if (g.hitTestRectangle(player, enemy)) {
            playerHit = true;
        }

        if(playerHit) {
          player.alpha = 0.5;
          healthBar.inner.width -= 1;
        } else {
          player.alpha = 1;
        }

        if (g.hitTestRectangle(player, treasure)) {

          treasure.x = player.x + 8;
          treasure.y = player.y + 8;

          if(!treasure.pickedUp) {
            //chimes.play();
            treasure.pickedUp = true;
          };
        }

        if (healthBar.inner.width < 0) {
            g.state = end;
            message.content = "You lost!";
        }

        if (g.hitTestRectangle(treasure, exit)) {
            g.state = end;
            message.content = "You won!";
        }
    });

    function end() {
        gameScene.visible = false;
        gameOverScene.visible = true;
    }
}
</script>
</body>